<html>
  <head>
    <meta charset="UTF-8">
    <title>Placeholder Name</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src = "func.js"></script>
    <link rel = "stylesheet" href = "index.css">
  </head>
  <body>
    <div>
      <h1 class = "center" style = "padding-top:10%; opacity: 0;" id = "welcome">Welcome</h1>
      <h2 class = "center" style = "opacity: 0;" id = "inst">Click an option to get started</h2>
      <div class = "content" id = "createDiv">
        <a onclick = "create()" class="myButton" style = "opacity: 0;" id = "create">Create Account</a>
      </div>
      <br>
      <br>
      <div class = "content" id = "loginDiv">
        <a onclick = "login()" class="myButton" style = "opacity: 0;" id = "login">Login</a>
      </div>
    </div>
  </body>
  <footer>
  </footer>
  <script>
    fadeIn("welcome", 0);
    fadeIn("inst", 500);
    fadeIn("create", 1000);
    fadeIn("login", 1500);

    function create() {
      const create = document.getElementById("create");
      fadeOut("welcome", 0);
      fadeOut("inst", 150);
      fadeOut("login", 200);
      moveUp("create", 750);
      setTimeout(function() {
        document.getElementById("loginDiv").remove();
        document.getElementById("welcome").remove();
        document.getElementById("inst").remove();

        var newInput = document.createElement("input");
        insertAfter(newInput, document.getElementById("createDiv"));
        newInput.id = "nameInput";
        newInput.style.top = document.getElementById("create").offsetTop + 90 +"px";
        newInput.style.opacity = 0;
        var newLabel = document.createElement("label");
        newLabel.id = "nameLabel";
        newLabel.innerHTML = "Full Name: ";
        newLabel.for = "nameInput";
        insertAfter(newLabel, newInput);
        newLabel.style.top = document.getElementById("create").offsetTop + 90 +"px";
        newInput.style.left = newLabel.offsetLeft + newLabel.offsetWidth + 10 +"px";
        newLabel.style.opacity = 0;

        newInput = document.createElement("input");
        insertAfter(newInput, document.getElementById("createDiv"));
        newInput.id = "emailInput";
        newInput.style.top = document.getElementById("create").offsetTop + 90*2 +"px";
        newInput.style.opacity = 0;
        newLabel = document.createElement("label");
        newLabel.id = "emailLabel";
        newLabel.innerHTML = "Email: ";
        newLabel.for = "emailInput";
        insertAfter(newLabel, newInput);
        newLabel.style.top = document.getElementById("create").offsetTop + 90*2 +"px";
        newInput.style.left = document.getElementById("nameInput").offsetLeft + "px";
        newLabel.style.opacity = 0;

        newInput = document.createElement("input");
        insertAfter(newInput, document.getElementById("createDiv"));
        newInput.id = "passwordInput";
        newInput.style.top = document.getElementById("create").offsetTop + 90*3 +"px";
        newInput.style.opacity = 0;
        newLabel = document.createElement("label");
        newLabel.id = "passwordLabel";
        newLabel.type = "password";
        newLabel.innerHTML = "Password: ";
        newLabel.for = "passwordInput";
        insertAfter(newLabel, newInput);
        newLabel.style.top = document.getElementById("create").offsetTop + 90*3 +"px";
        newInput.style.left = document.getElementById("nameInput").offsetLeft + "px";
        newLabel.style.opacity = 0;

        //<a onclick = "create()" class="myButton" style = "opacity: 0;" id = "create">Create Account</a>
        const newButton = document.createElement("a");
        newButton.id = "createSubmit";
        newButton.innerHTML = "Submit";
        newButton.classList.add("myButton");
        newButton.onclick = function() {createSubmit()};
        insertAfter(newButton, newLabel);
        newButton.style.opacity = 0;
        newButton.style.position = "absolute";
        newButton.style.top = document.getElementById("create").offsetTop + 90*4 +"px";
        newButton.style.left = document.getElementById("create").offsetLeft + "px";

        const errorMsg = document.createElement("h2");
        errorMsg.id = "error";
        errorMsg.innerHTML = "";
        errorMsg.style.color = "red";
        insertAfter(errorMsg, newButton);
        errorMsg.style.position = "absolute";
        errorMsg.style.top = document.getElementById("create").offsetTop + 90*5 +"px";
        errorMsg.style.left = document.getElementById("create").offsetLeft + "px";

        fadeIn("nameLabel", 0);
        fadeIn("nameInput", 150);
        fadeIn("emailLabel", 300);
        fadeIn("emailInput", 450);
        fadeIn("passwordLabel", 600);
        fadeIn("passwordInput", 750);
        fadeIn("createSubmit", 900);
      }, 1200);
    }

    function login() {
      const create = document.getElementById("login");
      fadeOut("welcome", 0);
      fadeOut("inst", 150);
      fadeOut("create", 200);
      moveUp("login", 750)
      setTimeout(function() {
        document.getElementById("createDiv").remove();
        document.getElementById("welcome").remove();
        document.getElementById("inst").remove();

        var newInput = document.createElement("input");
        insertAfter(newInput, document.getElementById("loginDiv"));
        newInput.id = "nameInput";
        newInput.style.top = document.getElementById("login").offsetTop + 90 +"px";
        newInput.style.opacity = 0;
        var newLabel = document.createElement("label");
        newLabel.id = "nameLabel";
        newLabel.innerHTML = "Email: ";
        newLabel.for = "nameInput";
        insertAfter(newLabel, newInput);
        newLabel.style.top = document.getElementById("login").offsetTop + 90 +"px";
        newInput.style.left = newLabel.offsetLeft + newLabel.offsetWidth + 90 +"px";
        newLabel.style.opacity = 0;

        newInput = document.createElement("input");
        insertAfter(newInput, document.getElementById("loginDiv"));
        newInput.id = "emailInput";
        newInput.style.top = document.getElementById("login").offsetTop + 90*2 +"px";
        newInput.style.opacity = 0;
        newLabel = document.createElement("label");
        newLabel.id = "emailLabel";
        newLabel.innerHTML = "Password: ";
        newLabel.for = "emailInput";
        insertAfter(newLabel, newInput);
        newLabel.style.top = document.getElementById("login").offsetTop + 90*2 +"px";
        newInput.style.left = document.getElementById("nameInput").offsetLeft + "px";
        newLabel.style.opacity = 0;

        //<a onclick = "create()" class="myButton" style = "opacity: 0;" id = "create">Create Account</a>
        const newButton = document.createElement("a");
        newButton.id = "createSubmit";
        newButton.innerHTML = "Submit";
        newButton.classList.add("myButton");
        newButton.onclick = function() {loginCheck()};
        insertAfter(newButton, newLabel);
        newButton.style.opacity = 0;
        newButton.style.position = "absolute";
        newButton.style.top = document.getElementById("login").offsetTop + 90*3 +"px";
        newButton.style.left = document.getElementById("login").offsetLeft + "px";

        const errorMsg = document.createElement("h2");
        errorMsg.id = "error";
        errorMsg.innerHTML = "";
        errorMsg.style.color = "red";
        insertAfter(errorMsg, newButton);
        errorMsg.style.position = "absolute";
        errorMsg.style.top = document.getElementById("login").offsetTop + 90*4 +"px";
        errorMsg.style.left = document.getElementById("login").offsetLeft + "px";

        fadeIn("nameLabel", 0);
        fadeIn("nameInput", 150);
        fadeIn("emailLabel", 300);
        fadeIn("emailInput", 450);
        fadeIn("createSubmit", 600);
      }, 1200);
    }

    function createSubmit() {

      const errorMsg = document.getElementById("error");
      var res = checkSubmission();
      if (res != "") {
        errorMsg.innerHTML = res;
        return;
      }

      var mysql = require('mysql');
      var user;
      var pass;

      var lineReader = require('readline').createInterface({
        input: require('fs').createReadStream('server-credentials.txt')
      });

      var x = 0;
      lineReader.on('line', function (line) {
        if (x == 0) {
          user = line;
          x++;
        } else if (x == 1){
          pass = line;
          x++;
        }
      });

      setTimeout(function(){

        var conn = mysql.createConnection({
          host: "DESKTOP-G951QGH",
          port: "3306",
          user: user,
          password: pass,
          database: "warehouse_proj",
        });

        conn.connect(function(err) {
          if (err) {
            errorMsg.innerHTML = err;
            throw err;
          }
          conn.query("SELECT * FROM warehouse_proj.account_info WHERE email = \"" + emailInput.value + "\";", function (err, result) {
            if (err) {
              errorMsg.innerHTML = err;
              throw err;
            } else if (result.length != 0) {
              errorMsg.innerHTML = "Email Taken!";
            } else {
              conn.query("INSERT INTO account_info VALUES ('" + nameInput.value + "', '" + emailInput.value + "', '" + passwordInput.value +"');", function (err, result) {
                if (err) {
                  errorMsg.innerHTML = err;
                  throw err;
                }
                errorMsg.innerHTML = "Account created!";
                errorMsg.style.color = "white";
                document.getElementById("createSubmit").onclick = "";
                setTimeout(function(){
                  location.reload();
                }, 3000);
              });
            }
          });
        });

      }, 100);
    }

    function checkSubmission() {
      const email = document.getElementById("emailInput").value;
      const password = document.getElementById("passwordInput").value;
      const re = /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
      if (!re.test(email)) {
        return "Email has wrong format!";
      } else if (password.length < 6) {
        return "Password not long enough!";
      }

      return "";
    }

    function loginCheck() {

      const errorMsg = document.getElementById("error");
      const email = document.getElementById("nameInput");
      var password = document.getElementById("emailInput");

      var mysql = require('mysql');
      var user;
      var pass;

      var lineReader = require('readline').createInterface({
        input: require('fs').createReadStream('server-credentials.txt')
      });

      var x = 0;
      lineReader.on('line', function (line) {
        if (x == 0) {
          user = line;
          x++;
        } else if (x == 1){
          pass = line;
          x++;
        }
      });


      errorMsg.innerHTML = "Logging in...";
      errorMsg.style.color = "white";

      setTimeout(function(){

        var conn = mysql.createConnection({
          host: "DESKTOP-G951QGH",
          port: "3306",
          user: user,
          password: pass,
          //database: "warehouse_proj",
        });

        conn.connect(function(err) {
          if (err) {
            errorMsg.innerHTML = err;
            throw err;
          }
          conn.query("SELECT password FROM warehouse_proj.account_info WHERE email = \"" + email.value + "\";", function (err, result) {
            if (err) {
              errorMsg.innerHTML = err;
              throw err;
            }
            if (result.length == 0) {
              errorMsg.style.color = "red";
              errorMsg.innerHTML = "Wrong Email!";
            } else if (result[0].password != password.value) {
              errorMsg.style.color = "red";
              errorMsg.innerHTML = "Wrong Password!";
            } else {
              errorMsg.innerHTML = "Success!";
              document.getElementById("createSubmit").onclick = "";
              setTimeout(function(){
                location.assign("./dashboard/dashboard.html");
              }, 3000);
            }
          });
        });

      }, 100);
    }
  </script>
</html>
